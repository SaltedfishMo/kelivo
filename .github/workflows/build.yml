name: Flutter Android Build Only

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  android:
    name: æ„å»º Android
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• é…ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¦ å®‰è£… Flutter (Master)
        uses: subosito/flutter-action@v2
        with:
          channel: master
          cache: true

      - name: ğŸ“ æ³¨å…¥API Key
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart << 'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "VERSION=\(VERSION" >> \)GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      - name: ğŸ”‘ é…ç½®ç­¾å
        run: |
          if [ -n "${{ secrets.SIGN_KEYSTORE_BASE64 }}" ]; then
            echo "ä½¿ç”¨ä¸»äººæä¾›çš„ç­¾å"
            echo "${{ secrets.SIGN_KEYSTORE_BASE64 }}" | base64 --decode > android/app/key.jks
            echo "storeFile=key.jks" >> android/key.properties
            echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
            echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
            echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          else
            echo "ç”Ÿæˆä¸´æ—¶ç­¾å"
            keytool -genkey -v -keystore android/app/key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias key -storepass 123456 -keypass 123456 -dname "CN=AliceBuild,O=AliceCorp,C=CN"
            echo "storeFile=key.jks" > android/key.properties
            echo "storePassword=123456" >> android/key.properties
            echo "keyAlias=key" >> android/key.properties
            echo "keyPassword=123456" >> android/key.properties
          fi
          echo "âœ… ç­¾åé…ç½®å®Œæˆ"

      - name: ğŸ—ï¸ æ„å»º APK
        run: flutter build apk --release --split-per-abi

      - name: ğŸ“¦ é‡å‘½å APK
        run: |
          cd build/app/outputs/flutter-apk
          # ä»…å¤„ç†ä¸»äººéœ€è¦çš„ arm64 ç‰ˆæœ¬
          mv app-arm64-v8a-release.apk Kelivo_android_${VERSION}_arm64-v8a.apk

      - name: ğŸ“¤ ä¸Šä¼  arm64-v8a
        uses: actions/upload-artifact@v4
        with:
          name: Android-arm64-v8a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_arm64-v8a.apk
