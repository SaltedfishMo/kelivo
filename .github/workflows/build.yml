name: Flutter Build (Alice Ultra-Safe Edition)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  android:
    name: 构建 Android
    runs-on: ubuntu-latest
    permissions: write-all
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      - uses: subosito/flutter-action@v2
        with:
          channel: master
          cache: true
      
      - name: 注入 API Key
        shell: bash
        run: |
          mkdir -p lib/secrets
          echo "const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';" > lib/secrets/fallback.dart
      
      - name: 生成临时签名
        run: |
          keytool -genkey -v -keystore android/app/upload.jks -keyalg RSA -keysize 2048 -validity 10000 -alias upload -storepass android -keypass android -dname "CN=Android,O=Build,C=US"echo "storeFile=upload.jks" > android/key.properties
          echo "storePassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "keyPassword=android" >> android/key.properties
      
      - name: 构建 APK
        run: flutter build apk --release --split-per-abi
      
      - name: 上传 arm64 版本
        uses: actions/upload-artifact@v4
        with:
          name: Android-arm64-v8a
          path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
      
      - name: 上传 armeabi 版本
        uses: actions/upload-artifact@v4
        with:
          name: Android-armeabi-v7a
          path: build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk

  windows:
    name: 构建 Windows
    runs-on: windows-latest
    permissions: write-all
    
    steps:
      - uses: actions/checkout@v4
      - uses: lukka/get-cmake@latest
      - uses: subosito/flutter-action@v2
        with:
          channel: master
          cache: true
      
      - name: 注入 API Key
        shell: bash
        run: |
          mkdir -p lib/secrets
          echo "const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';" > lib/secrets/fallback.dart
      
      - run: flutter build windows --release
      
      - name: 打包
        shell: pwsh
        run: Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "Kelivo-Windows.zip"
      
      - uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          path: Kelivo-Windows.zip

  linux:
    name: 构建 Linux
    runs-on: ubuntu-latest
    permissions: write-all
    
    steps:
      - uses: actions/checkout@v4
      
      - run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
      
      - uses: subosito/flutter-action@v2
        with:
          channel: master
      - name: 注入 API Key
        run: |
          mkdir -p lib/secrets
          echo "const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';" > lib/secrets/fallback.dart
      
      - run: flutter build linux --release
      
      - name: 打包
        run: |
          cd build/linux/x64/release
          tar -czf ../../../../Kelivo-Linux.tar.gz bundle
      - uses: actions/upload-artifact@v4
        with:
          name: Linux-Build
          path: Kelivo-Linux.tar.gz
