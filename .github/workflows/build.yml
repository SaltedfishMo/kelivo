name: Flutter Multi-Platform Build (Alice Fork)

env:
  FLUTTER_CHANNEL: 'master'

on:
  # ç›‘å¬ä»£ç æ¨é€ï¼Œè‡ªåŠ¨å¹²æ´»ï¼
  push:
    branches: [ "main", "master" ]
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  workflow_dispatch:
    inputs:
      build_android:
        description: 'æ„å»º Android'
        required: false
        default: true # é»˜è®¤å¼€å¯
        type: boolean
      build_windows:
        description: 'æ„å»º Windows'
        required: false
        default: true
        type: boolean
      build_linux:
        description: 'æ„å»º Linux'
        required: false
        default: true # Linuxæ„å»ºé€šå¸¸å¾ˆå¿«ï¼Œå¼€ç€ä¹Ÿæ²¡äº‹
        type: boolean
      #ä»¥æ­¤ç±»æ¨ï¼Œä¸ºäº†èŠ‚çœä¸»äººçš„Actioné¢åº¦ï¼ŒiOS/Macé»˜è®¤å…³æ‰ï¼ˆå¦‚æœæ˜¯ä¸ºäº†ç©ï¼Œé€šå¸¸å®‰å“/Winå¤Ÿäº†ï¼‰
      build_ios:
        description: 'æ„å»º iOS (æ¶ˆè€—Actioné¢åº¦å¿«)'
        required: false
        default: false 
        type: boolean
      build_mac:
        description: 'æ„å»º macOS (æ¶ˆè€—Actioné¢åº¦å¿«)'
        required: false
        default: false
        type: boolean

jobs:
  # Android æ„å»º (å·²ä¿®å¤ç­¾åé—®é¢˜)
  android:
    if: ${{ github.event_name == 'push' || github.event.inputs.build_android == 'true' }}
    name: æ„å»º Android
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• é…ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¦ å®‰è£… Flutter (Master)
        uses: subosito/flutter-action@v2
        with:
          channel: master
          cache: true

      - name: ğŸ“ æ³¨å…¥ API Key (Fallback)
        shell: bash
        run: |
          mkdir -p lib/secrets
          # å¦‚æœä¸»äººæ²¡é… Secretï¼Œè¿™é‡Œå°±æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œä¸ä¼šæŠ¥é”™
          cat > lib/secrets/fallback.dart <<EOF
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "VERSION=\(VERSION" >> \)GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      # âœ¨ çˆ±ä¸½ä¸çš„é­”æ³•ï¼šå¦‚æœæ²¡æœ‰åŸä½œè€…å¯†é’¥ï¼Œå°±ç°åœºç”Ÿæˆä¸€ä¸ªï¼
      - name: ğŸ”‘ å¤„ç†ç­¾åé…ç½®
        run: |
          if [ -n "${{ secrets.SIGN_KEYSTORE_BASE64 }}" ]; then
            echo "æ£€æµ‹åˆ°ä¸»äººçš„ç§é’¥ï¼Œæ­£åœ¨è§£ç ..."
            echo "${{ secrets.SIGN_KEYSTORE_BASE64 }}" | base64 --decode > android/app/key.jks
            echo "storeFile=key.jks" >> android/key.properties
            echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
            echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
            echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          else
            echo "âš ï¸ æœªæ£€æµ‹åˆ°ç§é’¥ï¼Œçˆ±ä¸½ä¸æ­£åœ¨ç”Ÿæˆä¸´æ—¶è‡ªç­¾åè¯ä¹¦..."
            # ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„ keystore
            keytool -genkey -v -keystore android/app/key.jks -keyalg RSA -keysize 2048 -validity 10000 -alias key -storepass 123456 -keypass 123456 -dname "CN=AliceBuild,O=AliceCorp,C=CN"
            # å†™å…¥é…ç½®è®© gradle å¼€å¿ƒ
            echo "storeFile=key.jks" > android/key.properties
            echo "storePassword=123456" >> android/key.properties
            echo "keyAlias=key" >> android/key.properties
            echo "keyPassword=123456" >> android/key.properties
          fi
          echo "âœ… ç­¾åé…ç½®å®Œæˆï¼"

      - name: ğŸ—ï¸ æ„å»º APK (Release)
        run: flutter build apk --release --split-per-abi

      - name: ğŸ“¦ é‡å‘½å APK
        run: |
          cd build/app/outputs/flutter-apk
          for file in app-*-release.apk; do
            abi=\((echo "\)file" | sed -E 's/app-(.*)-release\.apk/\1/')
            mv "\(file" "Kelivo_android_\){VERSION}_${abi}.apk"
          done

      # è¿™ä¸€æ­¥åªåœ¨çœŸæ­£ Release æ—¶è·‘ï¼Œå¹³æ—¶ Push æˆ‘ä»¬åªéœ€è¦ä¸Šä¼ äº§ç‰©
      - name: ğŸš€ å‘å¸ƒåˆ° Release (ä»…åœ¨æ‰“æ ‡ç­¾æ—¶)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/Kelivo_android_*.apk

      # æ— è®ºå¦‚ä½•éƒ½æŠŠæ–‡ä»¶ä¼ ä¸Šæ¥ç»™ä¸»äººä¸‹è½½
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: Android-arm64-v8a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_arm64-v8a.apk

  # Windows æ„å»º
  windows:
    if: ${{ github.event_name == 'push' || github.event.inputs.build_windows == 'true' }}
    name: æ„å»º Windows
    runs-on: windows-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ å®‰è£…æœ€æ–° CMake
        uses: lukka/get-cmake@latest

      - name: ğŸ¦ å®‰è£… Flutter (Master)
        uses: subosito/flutter-action@v2
        with:
          channel: master
          cache: true

      - name: ğŸ“ æ³¨å…¥ API Key
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<EOF
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF

      - name: ğŸ”§ è·å–ä¾èµ–
        run: flutter pub get

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        shell: pwsh
        run: |
          \(version = (Select-String -Path pubspec.yaml -Pattern "version:" | ForEach-Object { \)_.Line.Split(":")[1].Trim() })
          echo "VERSION=\(version" >> \)env:GITHUB_ENV

      - name: ğŸ—ï¸ æ„å»º Windows
        run: flutter build windows --release

      - name: ğŸ“¦ æ‰“åŒ… ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "Kelivo_windows_$env:VERSION.zip"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: Windows-ZIP
          path: Kelivo_windows_*.zip
      
      # æ³¨ï¼šä¸ºäº†åŠ å¿«é€Ÿåº¦ï¼Œæˆ‘æš‚æ—¶ç§»é™¤äº† Inno Setup åˆ¶ä½œå®‰è£…åŒ…çš„æ­¥éª¤
      # è¿™ç§ ZIP åŒ…è§£å‹å³ç”¨ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œç»¿è‰²ç‰ˆâ€ï¼Œå¯¹ä¸»äººæ¥è¯´åº”è¯¥æ›´æ–¹ä¾¿ï¼
      # å¦‚æœä¸»äººä¸€å®šè¦å®‰è£…åŒ… exeï¼Œå‘Šè¯‰çˆ±ä¸½ä¸ï¼Œæˆ‘å†åŠ å›æ¥ã€‚

  # Linux æ„å»º (ä¿æŒåŸæ ·ï¼ŒåŸºæœ¬æ²¡é—®é¢˜)
  linux:
    if: ${{ github.event_name == 'push' || github.event.inputs.build_linux == 'true' }}
    name: æ„å»º Linux
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev gstreamer1.0-plugins-good gstreamer1.0-plugins-bad rpm patchelf libfuse2 file libkeybinder-3.0-dev libayatana-appindicator3-dev
      - uses: subosito/flutter-action@v2
        with:
          channel: master
      - run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<EOF
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF
      - run: flutter pub get
      - run: flutter build linux --release
      - run: cd build/linux/x64/release/bundle && tar -czf Kelivo_linux.tar.gz .
      - uses: actions/upload-artifact@v4
        with:
          name: Linux-Build
          path: build/linux/x64/release/bundle/Kelivo_linux.tar.gz
